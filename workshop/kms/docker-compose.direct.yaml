# dstack-kms production auth path (Direct RPC)
#
# KMS starts an HTTP onboard service on first boot.
# After Bootstrap or Onboard completes, restart transitions to HTTPS.
#
# Usage:
#   cp docker-compose.direct.yaml docker-compose.yaml
#   docker compose up -d
#   # then call /prpc/Onboard.Bootstrap via curl, followed by /finish

services:
  auth-api:
    image: node:20-bookworm-slim
    restart: unless-stopped
    ports:
      - "${AUTH_HTTP_PORT:-18000}:8000"
    environment:
      - HOST=0.0.0.0
      - PORT=8000
      - ETH_RPC_URL=${ETH_RPC_URL:?set ETH_RPC_URL in .env}
      - KMS_CONTRACT_ADDR=${KMS_CONTRACT_ADDR:?set KMS_CONTRACT_ADDR in .env}
      - DSTACK_REPO=${DSTACK_REPO:-https://github.com/Phala-Network/dstack-cloud.git}
      - DSTACK_REF=${DSTACK_REF:-fc6a43fe}
    volumes:
      - auth-state:/state
    command:
      - bash
      - -lc
      - |
        set -euo pipefail
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -y >/dev/null
        apt-get install -y --no-install-recommends git python3 make g++ ca-certificates >/dev/null
        rm -rf /var/lib/apt/lists/*

        if [ ! -d /state/auth-eth ]; then
          git clone "$${DSTACK_REPO}" /state/dstack
          cd /state/dstack
          git checkout "$${DSTACK_REF}"
          cp -a kms/auth-eth /state/auth-eth
          cd /state/auth-eth
          npm ci --silent
          npm run build --silent
        fi

        cd /state/auth-eth
        exec node dist/src/main.js

  kms:
    image: ${KMS_IMAGE:-cr.kvin.wang/dstack-kms:latest}
    restart: unless-stopped
    depends_on:
      - auth-api
    volumes:
      - kms-volume:/kms
      - /var/run/dstack.sock:/var/run/dstack.sock
    ports:
      - "${KMS_HTTPS_PORT:-12001}:8000"
    command:
      - sh
      - -c
      - |
        set -e
        mkdir -p /kms/certs /kms/images
        cat > /kms/kms.toml <<EOK
        [rpc]
        address = "0.0.0.0"
        port = 8000

        [rpc.tls]
        key = "/kms/certs/rpc.key"
        certs = "/kms/certs/rpc.crt"

        [rpc.tls.mutual]
        ca_certs = "/kms/certs/tmp-ca.crt"
        mandatory = false

        [core]
        cert_dir = "/kms/certs"
        admin_token_hash = ""

        [core.image]
        verify = true
        cache_dir = "/kms/images"
        download_url = "http://localhost:8000/{OS_IMAGE_HASH}.tar.gz"
        download_timeout = "2m"

        [core.auth_api]
        type = "webhook"

        [core.auth_api.webhook]
        url = "http://auth-api:8000"

        [core.onboard]
        enabled = true
        auto_bootstrap_domain = ""
        quote_enabled = true
        address = "0.0.0.0"
        port = 8000
        EOK

        exec dstack-kms -c /kms/kms.toml

volumes:
  kms-volume:
  auth-state:
